# Needle ConfigMap Configuration
# ===============================
# ConfigMaps store non-sensitive configuration data as key-value pairs.
# This file contains all configuration needed for Needle components.
#
# Best Practices:
# - Never store secrets in ConfigMaps (use Secrets instead)
# - Use immutable ConfigMaps when possible for performance
# - Version ConfigMaps for rollback capability
# - Keep configuration DRY with shared base configs

apiVersion: v1
kind: ConfigMap
metadata:
  name: needle-config
  namespace: needle
  labels:
    app: needle
    component: config
  annotations:
    # Track configuration version for auditing
    needle.io/config-version: "1.0.0"
data:
  # Environment variables for Needle components
  # These are loaded via envFrom in the deployment

  # Server Configuration
  NEEDLE_SERVER_HOST: "0.0.0.0"
  NEEDLE_SERVER_PORT: "8080"
  NEEDLE_GRPC_PORT: "9000"
  NEEDLE_METRICS_PORT: "9090"

  # Logging Configuration
  # Log levels: debug, info, warn, error
  NEEDLE_LOG_LEVEL: "info"
  NEEDLE_LOG_FORMAT: "json"
  NEEDLE_LOG_OUTPUT: "stdout"

  # Cluster Configuration
  NEEDLE_CLUSTER_NAME: "needle-production"
  NEEDLE_CLUSTER_REGION: "us-east-1"
  NEEDLE_CLUSTER_DISCOVERY: "kubernetes"
  NEEDLE_CLUSTER_NAMESPACE: "needle"

  # Storage Configuration
  NEEDLE_STORAGE_TYPE: "tiered"
  NEEDLE_STORAGE_DATA_DIR: "/data/needle"
  NEEDLE_STORAGE_CACHE_DIR: "/var/cache/needle"
  NEEDLE_STORAGE_CACHE_SIZE: "1GB"

  # Tiered Storage Configuration
  NEEDLE_STORAGE_HOT_PATH: "/data/needle/hot"
  NEEDLE_STORAGE_WARM_PATH: "/data/needle/warm"
  NEEDLE_STORAGE_COLD_PATH: "/data/needle/cold"
  NEEDLE_STORAGE_HOT_MAX_SIZE: "10GB"
  NEEDLE_STORAGE_WARM_MAX_SIZE: "50GB"
  NEEDLE_STORAGE_TIER_POLICY: "lru"

  # Replication Configuration
  NEEDLE_REPLICATION_FACTOR: "3"
  NEEDLE_REPLICATION_MIN_REPLICAS: "2"
  NEEDLE_REPLICATION_ASYNC: "false"

  # Query Configuration
  NEEDLE_QUERY_TIMEOUT: "30s"
  NEEDLE_QUERY_MAX_RESULTS: "10000"
  NEEDLE_QUERY_CACHE_ENABLED: "true"
  NEEDLE_QUERY_CACHE_TTL: "5m"

  # Index Configuration
  NEEDLE_INDEX_TYPE: "hnsw"
  NEEDLE_INDEX_M: "16"
  NEEDLE_INDEX_EF_CONSTRUCTION: "200"
  NEEDLE_INDEX_EF_SEARCH: "100"

  # Performance Tuning
  NEEDLE_WORKERS: "4"
  NEEDLE_MAX_CONNECTIONS: "1000"
  NEEDLE_CONNECTION_TIMEOUT: "10s"
  NEEDLE_IDLE_TIMEOUT: "120s"
  NEEDLE_READ_TIMEOUT: "30s"
  NEEDLE_WRITE_TIMEOUT: "30s"

  # Health Check Configuration
  NEEDLE_HEALTH_CHECK_INTERVAL: "10s"
  NEEDLE_HEALTH_CHECK_TIMEOUT: "5s"

  # Metrics Configuration
  NEEDLE_METRICS_ENABLED: "true"
  NEEDLE_METRICS_PREFIX: "needle"
  NEEDLE_METRICS_HISTOGRAM_BUCKETS: "0.001,0.005,0.01,0.025,0.05,0.1,0.25,0.5,1,2.5,5,10"

  # Feature Flags
  NEEDLE_FEATURE_COMPRESSION: "true"
  NEEDLE_FEATURE_ENCRYPTION: "true"
  NEEDLE_FEATURE_AUDIT_LOG: "true"

  # Main configuration file
  # Mounted as /etc/needle/needle.yaml
  needle.yaml: |
    # Needle Server Configuration
    # ===========================
    # This is the main configuration file for Needle.
    # Environment variables override these settings.

    server:
      host: ${NEEDLE_SERVER_HOST:0.0.0.0}
      port: ${NEEDLE_SERVER_PORT:8080}
      grpc_port: ${NEEDLE_GRPC_PORT:9000}
      metrics_port: ${NEEDLE_METRICS_PORT:9090}

      # TLS Configuration (optional)
      tls:
        enabled: false
        cert_file: /etc/needle/tls/tls.crt
        key_file: /etc/needle/tls/tls.key
        ca_file: /etc/needle/tls/ca.crt

      # Request limits
      limits:
        max_request_size: 100MB
        max_batch_size: 1000
        rate_limit: 10000  # requests per second

    logging:
      level: ${NEEDLE_LOG_LEVEL:info}
      format: ${NEEDLE_LOG_FORMAT:json}
      output: ${NEEDLE_LOG_OUTPUT:stdout}

      # Structured logging fields
      fields:
        service: needle
        version: "1.0.0"

    cluster:
      name: ${NEEDLE_CLUSTER_NAME:needle-production}
      region: ${NEEDLE_CLUSTER_REGION:us-east-1}

      # Service discovery configuration
      discovery:
        type: ${NEEDLE_CLUSTER_DISCOVERY:kubernetes}
        kubernetes:
          namespace: ${NEEDLE_CLUSTER_NAMESPACE:needle}
          service_name: needle-storage-headless
          port_name: gossip

      # Gossip protocol for cluster membership
      gossip:
        bind_port: 7946
        advertise_port: 7946
        secret_key: ""  # Set via NEEDLE_GOSSIP_SECRET_KEY

      # Consensus configuration
      consensus:
        type: raft
        election_timeout: 1s
        heartbeat_timeout: 100ms
        snapshot_interval: 10m
        snapshot_threshold: 8192

    storage:
      type: ${NEEDLE_STORAGE_TYPE:tiered}
      data_dir: ${NEEDLE_STORAGE_DATA_DIR:/data/needle}

      # Cache configuration
      cache:
        enabled: true
        dir: ${NEEDLE_STORAGE_CACHE_DIR:/var/cache/needle}
        size: ${NEEDLE_STORAGE_CACHE_SIZE:1GB}
        eviction_policy: lru

      # Tiered storage configuration
      tiers:
        hot:
          path: ${NEEDLE_STORAGE_HOT_PATH:/data/needle/hot}
          max_size: ${NEEDLE_STORAGE_HOT_MAX_SIZE:10GB}
          # Data accessed within last 24 hours
          age_threshold: 24h
          storage_class: ssd

        warm:
          path: ${NEEDLE_STORAGE_WARM_PATH:/data/needle/warm}
          max_size: ${NEEDLE_STORAGE_WARM_MAX_SIZE:50GB}
          # Data accessed within last 7 days
          age_threshold: 168h
          storage_class: hdd

        cold:
          path: ${NEEDLE_STORAGE_COLD_PATH:/data/needle/cold}
          # No size limit; uses external storage
          age_threshold: 720h  # 30 days
          storage_class: object
          # S3-compatible storage for cold tier
          object_storage:
            endpoint: ""  # Set via NEEDLE_S3_ENDPOINT
            bucket: ""    # Set via NEEDLE_S3_BUCKET
            region: ""    # Set via NEEDLE_S3_REGION

      # Compaction settings
      compaction:
        enabled: true
        interval: 1h
        min_files: 4
        max_files: 32
        target_file_size: 256MB

      # Write-ahead log configuration
      wal:
        enabled: true
        dir: ${NEEDLE_STORAGE_DATA_DIR:/data/needle}/wal
        sync_on_write: true
        max_segment_size: 64MB
        retention: 24h

    replication:
      factor: ${NEEDLE_REPLICATION_FACTOR:3}
      min_replicas: ${NEEDLE_REPLICATION_MIN_REPLICAS:2}
      async: ${NEEDLE_REPLICATION_ASYNC:false}

      # Consistency levels
      read_consistency: quorum   # one, quorum, all
      write_consistency: quorum  # one, quorum, all

    index:
      type: ${NEEDLE_INDEX_TYPE:hnsw}

      # HNSW algorithm parameters
      hnsw:
        m: ${NEEDLE_INDEX_M:16}
        ef_construction: ${NEEDLE_INDEX_EF_CONSTRUCTION:200}
        ef_search: ${NEEDLE_INDEX_EF_SEARCH:100}
        max_elements: 10000000

      # Index maintenance
      maintenance:
        rebuild_threshold: 0.3  # Rebuild when 30% deleted
        optimize_interval: 24h

    query:
      timeout: ${NEEDLE_QUERY_TIMEOUT:30s}
      max_results: ${NEEDLE_QUERY_MAX_RESULTS:10000}

      # Query caching
      cache:
        enabled: ${NEEDLE_QUERY_CACHE_ENABLED:true}
        ttl: ${NEEDLE_QUERY_CACHE_TTL:5m}
        max_entries: 10000

    metrics:
      enabled: ${NEEDLE_METRICS_ENABLED:true}
      prefix: ${NEEDLE_METRICS_PREFIX:needle}

      # Histogram buckets for latency metrics
      histogram_buckets:
        - 0.001
        - 0.005
        - 0.01
        - 0.025
        - 0.05
        - 0.1
        - 0.25
        - 0.5
        - 1
        - 2.5
        - 5
        - 10

    health:
      check_interval: ${NEEDLE_HEALTH_CHECK_INTERVAL:10s}
      check_timeout: ${NEEDLE_HEALTH_CHECK_TIMEOUT:5s}

      # Dependencies to check for readiness
      dependencies:
        - name: storage
          critical: true
        - name: cluster
          critical: true
        - name: index
          critical: false

    security:
      # Authentication
      auth:
        enabled: true
        type: token  # token, mtls, oidc
        token_header: X-Needle-Token

      # Encryption at rest
      encryption:
        enabled: ${NEEDLE_FEATURE_ENCRYPTION:true}
        algorithm: AES-256-GCM
        key_rotation_interval: 30d

      # Audit logging
      audit:
        enabled: ${NEEDLE_FEATURE_AUDIT_LOG:true}
        log_reads: false
        log_writes: true
        log_admin: true

---
# Separate ConfigMap for scripts
# Keeps scripts separate from configuration for clarity
apiVersion: v1
kind: ConfigMap
metadata:
  name: needle-scripts
  namespace: needle
  labels:
    app: needle
    component: scripts
data:
  # Health check script for complex health validation
  healthcheck.sh: |
    #!/bin/sh
    set -e

    # Check HTTP endpoint
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health/ready)
    if [ "$HTTP_STATUS" != "200" ]; then
      echo "HTTP health check failed with status: $HTTP_STATUS"
      exit 1
    fi

    # Check gRPC endpoint (if grpcurl is available)
    if command -v grpcurl &> /dev/null; then
      grpcurl -plaintext localhost:9000 grpc.health.v1.Health/Check || exit 1
    fi

    echo "Health check passed"
    exit 0

  # Initialization script for storage setup
  init-storage.sh: |
    #!/bin/sh
    set -e

    echo "Initializing Needle storage directories..."

    # Create tiered storage directories
    mkdir -p /data/needle/hot
    mkdir -p /data/needle/warm
    mkdir -p /data/needle/cold
    mkdir -p /data/needle/wal

    # Set permissions
    chmod 750 /data/needle
    chmod 750 /data/needle/*

    echo "Storage initialization complete"

  # Backup script for data protection
  backup.sh: |
    #!/bin/sh
    set -e

    BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$BACKUP_DIR"

    echo "Starting backup to $BACKUP_DIR..."

    # Snapshot the current state
    curl -X POST http://localhost:8080/admin/snapshot

    # Copy data files
    cp -r /data/needle/hot "$BACKUP_DIR/"
    cp -r /data/needle/warm "$BACKUP_DIR/"

    # Compress backup
    tar -czf "$BACKUP_DIR.tar.gz" -C "$(dirname $BACKUP_DIR)" "$(basename $BACKUP_DIR)"
    rm -rf "$BACKUP_DIR"

    echo "Backup completed: $BACKUP_DIR.tar.gz"

---
# Immutable ConfigMap for static configuration
# Immutable ConfigMaps improve performance and prevent accidental changes
apiVersion: v1
kind: ConfigMap
metadata:
  name: needle-config-v1
  namespace: needle
  labels:
    app: needle
    component: config
    version: v1
# Prevents any modifications to this ConfigMap
immutable: true
data:
  # Static configuration that doesn't change
  NEEDLE_VERSION: "1.0.0"
  NEEDLE_BUILD_DATE: "2024-01-01"
